# Varint 编码的规范

## Varint 编码简介

Varint（Variable-length integer）是一种用于编码整数的可变长度的编码方式，旨在减少存储空间，特别是对于小整数。
Varint 编码通过使用每个字节的最高位（MSB）作为续写标志位来实现。

## Varint 的工作原理

### 结构

每个字节的前 7 位用于存储数据，最高位（第 8 位）作为续写标志。

- **最高位为 1**：表示后续还有字节。
- **最高位为 0**：表示这是最后一个字节。

### 编码步骤

1. **分割整数**：将待编码的整数按 7 位一组，从最低位开始分割。
2. **设置续写标志**：
    - 对于除最后一组之外的每一组，设置最高位为 1。
    - 对于最后一组，设置最高位为 0。
3. **按顺序输出字节**：从最低有效字节到最高有效字节顺序输出。

## 编码示例

| 整数值   | 二进制表示          | 分组（7 位）               | 每组字节（含续写标志）                     | Varint 编码结果（十六进制）           |
|-------|----------------|-----------------------|---------------------------------|-----------------------------|
| 1     | `0000 0001`    | `0000001`             | `00000001`                      | `0x01`                      |
| 150   | `1001 0110`    | `0010110`, `0000001`  | `10010110`（续写），`00000001`（结束）   | `0x96 0x01`                 |
| 300   | `1 0010 1100`  | `001100`, `0000010`   | `10101100`（续写），`00000010`（结束）   | `0xAC 0x02`                 |

### 详细步骤

以整数 300 为例：

1. **二进制表示**：`1 0010 1100`（9 位）
2. **分组**：
    - 第一组（低 7 位）：`0010 1100`（44）
    - 第二组（高位）：`0000 0010`（2）
3. **设置续写标志**：
    - 第一组：`1 0010 1100` → `1010 1100`（0xAC）
    - 第二组：`0 0000 0010` → `0000 0010`（0x02）
4. **编码结果**：`0xAC 0x02`

## Varint 的解码过程

1. **初始化**：设定一个结果变量 `result = 0`，以及一个位移量 `shift = 0`。
2. **逐字节读取**：
    - 读取一个字节。
    - 提取前 7 位，并将其左移 `shift` 位后加到 `result`。
    - 如果最高位为 0，结束解码。
    - 如果最高位为 1，继续读取下一个字节，并增加 `shift`（通常每次增加 7）。
3. **完成**：解码后的 `result` 即为原始整数。

**示例**：解码 `0x96 0x01`

1. **第一个字节**：`0x96` → `1001 0110`
    - 数据位：`001 0110`（22）
    - 续写标志：1
    - `result += 22 << 0` → `result = 22`
    - 增加 `shift`：`shift = 7`
2. **第二个字节**：`0x01` → `0000 0001`
    - 数据位：`000 0001`（1）
    - 续写标志：0
    - `result += 1 << 7` → `result = 22 + 128 = 150`
    - 解码结束
3. **结果**：150

## Varint 编码的优势与局限

### **优势**：

- **节省空间**：对于小整数，Varint 编码非常高效，使用较少的字节表示。
- **灵活性**：可以编码任意大小的整数，只受限于实现的最大字节数。

### **局限**：

- **大整数开销大**：对于非常大的整数，Varint 编码可能会使用较多字节。
- **非对齐访问**：由于编码长度不固定，随机访问特定位置的数据较为困难。

