# ZigZag 编码

ZigZag 编码是一种将有符号整数（包括负数）映射为无符号整数的方法，目的是优化 Varint 编码效率。
通过这种编码方式，可以使得负数也能以较小的 Varint 字节数进行编码。

## ZigZag 编码的工作原理

ZigZag 编码通过以下公式将有符号整数转换为无符号整数：

### **32 位整数 (`sint32`)**：

```
ZigZag(n) = (n << 1) ^ (n >> 31)
```

### **64 位整数 (`sint64`)**：

```
ZigZag(n) = (n << 1) ^ (n >> 63)
```

**解释**：

- `n << 1`：将整数左移一位，相当于乘以 2。
- `n >> 31` 或 `n >> 63`：算术右移，提取符号位（对于负数，结果为 -1；对于非负数，结果为 0）。
- `^`：按位异或操作。

## **3.3. 编码示例**

| 有符号整数 (`n`) | ZigZag 编码结果       |
|-------------|-------------------|
| 0           | 0                 |
| -1          | 1                 |
| 1           | 2                 |
| -2          | 3                 |
| 2           | 4                 |
| -3          | 5                 |
| ...         | ...               |

**详细步骤**：

1. **正数**：

    - 直接左移一位。
    - 示例：`n = 1`
      ```
      ZigZag(1) = (1 << 1) ^ (1 >> 31) = 2 ^ 0 = 2
      ```

2. **负数**：

    - 左移一位后，与 -1 进行异或。
    - 示例：`n = -1`
      ```
      ZigZag(-1) = (-1 << 1) ^ (-1 >> 31) = -2 ^ -1 = 1
      ```

### **3.4. 反向解码**

将 ZigZag 编码的无符号整数转换回有符号整数：

- **32 位整数 (`sint32`)**：

  ```
  n = (ZigZag(n) >> 1) ^ -(ZigZag(n) & 1)
  ```

- **64 位整数 (`sint64`)**：

  ```
  n = (ZigZag(n) >> 1) ^ -(ZigZag(n) & 1)
  ```

**解释**：

- `ZigZag(n) >> 1`：右移一位，恢复原始的数值。
- `ZigZag(n) & 1`：提取最低位，确定原始数值的符号。
- `^ -`：根据最低位决定是否取反。

### **3.5. ZigZag 编码的优势**

- **高效编码**：对于小的有符号整数（包括负数），ZigZag 编码可以使其在 Varint 编码中使用更少的字节。
- **无符号整数优势**：Varint 编码对无符号整数优化更好，而 ZigZag 编码将有符号整数有效地映射为无符号整数。